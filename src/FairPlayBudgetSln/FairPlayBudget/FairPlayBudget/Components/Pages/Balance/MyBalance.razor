@using FairPlayBudget.Interfaces.Services
@using FairPlayBudget.Models.Balance
@using Microsoft.AspNetCore.Authorization
@attribute [Route(Common.Constants.AppRoutes.MyBalance)]
@attribute [Authorize]
<h3>MyBalance</h3>

@if (this.MyBalanceModel != null)
{
    <QuickGrid Items="@this.MyBalanceModel">
        <PropertyColumn Property="@(p=>p.DateTime)"></PropertyColumn>
        <PropertyColumn Property="@(p=>p.TransactionType)"></PropertyColumn>
        <PropertyColumn Property="@(p=>p.AmountInUsd)" Format="c"></PropertyColumn>
        <PropertyColumn Property="@(p=>p.Description)"></PropertyColumn>
    </QuickGrid>
    <p>
        Total Expenses: @TotalExpenses.ToString("c")
    </p>
    <p>
        Total Income: @TotalIncome.ToString("c")
    </p>
    <p>
        @if (this.NetIncome < 0)
        {
            <label class="text-danger">
                Net Income: @NetIncome.ToString("c")
            </label>
        }
        else
        {
            <label class="form-label">
                Net Income: @NetIncome.ToString("c")
            </label>
        }
    </p>
}

@code {
    [Inject]
    private IBalanceService? BalanceService { get; set; }
    private IQueryable<MyBalanceModel>? MyBalanceModel { get; set; }
    private decimal TotalExpenses { get; set; } = 0;
    private decimal TotalIncome { get; set; } = 0;
    private decimal NetIncome { get; set; } = 0;
    protected override async Task OnInitializedAsync()
    {
        var result = await this.BalanceService!.GetMyBalanceAsync(
            CancellationToken.None);
        this.MyBalanceModel = result.AsQueryable();
        this.TotalExpenses = this.MyBalanceModel
        .Where(p => p.TransactionType == "Debit").Sum(p => p.AmountInUsd);
        this.TotalIncome = this.MyBalanceModel
        .Where(p => p.TransactionType == "Credit").Sum(p => p.AmountInUsd);
        this.NetIncome = this.TotalIncome - this.TotalExpenses;
    }
}
